From b59e9fbb35ce3342d416a493f361b6d03dffeb66 Mon Sep 17 00:00:00 2001
From: nxf87843 <jean-yves.salaun@nxp.com>
Date: Fri, 9 Dec 2022 14:10:56 +0100
Subject: [PATCH 1/1] Update otbr-agent options and otbr-firewall for IW612 support

Signed-off-by: nxf87843 <jean-yves.salaun@nxp.com>
---
 script/otbr-firewall            |  8 ++++--
 script/otbr-firewall_README.txt | 44 +++++++++++++++++++++++++++++++++
 src/agent/otbr-agent.default.in |  2 +-
 3 files changed, 50 insertions(+), 3 deletions(-)
 create mode 100644 script/otbr-firewall_README.txt

diff --git a/script/otbr-firewall b/script/otbr-firewall
index 52cef42dd0..afbf20904e 100644
--- a/script/otbr-firewall
+++ b/script/otbr-firewall
@@ -41,8 +41,12 @@
 THREAD_IF="wpan0"
 OTBR_FORWARD_INGRESS_CHAIN="OTBR_FORWARD_INGRESS"
 
-. /lib/lsb/init-functions
-. /lib/init/vars.sh
+if [ -f /lib/lsb/init-functions ]; then
+ . /lib/lsb/init-functions
+fi
+if [ -f /lib/init/vars.sh ]; then
+ . /lib/init/vars.sh
+fi
 
 set -euxo pipefail
 
diff --git a/script/otbr-firewall_README.txt b/script/otbr-firewall_README.txt
new file mode 100644
index 0000000000..7347e8f2c6
--- /dev/null
+++ b/script/otbr-firewall_README.txt
@@ -0,0 +1,44 @@
+                         OTBR FIREWALL
+                         
+Installation:
+-------------
+
+1- copy all files on target, in:
+
+    /etc/init.d/otbr-firewall
+
+2- configure the target by running the following commands:
+
+It should be done only 1 time after flashing the IMX target, so first check the content of these files
+
+instructions comes from ot-br-posix/script/_ipforward: function ipforward_install().
+
+    echo "net.ipv6.conf.all.forwarding = 1" >  /etc/sysctl.d/60-otbr-ip-forward.conf
+    echo "net.ipv4.ip_forward = 1"          >> /etc/sysctl.d/60-otbr-ip-forward.conf
+
+instructions comes from ot-br-posix/script/_rt_tables: function rt_tables_install().
+
+    echo "88 openthread"                 >> /etc/iproute2/rt_tables
+
+    echo ""                              >> /etc/sysctl.conf
+    echo "# OpenThread configuration"    >> /etc/sysctl.conf
+    echo "net.core.optmem_max=65536"     >> /etc/sysctl.conf
+
+    sysctl -p /etc/sysctl.conf
+
+Execution:
+----------
+
+-for otbr-agent:
+
+    systemctl enable otbr-agent
+    systemctl start otbr-agent
+#To check if otbr is running    
+    systemctl status otbr-agent 
+
+-for otbr-firewall:
+
+   systemctl enable otbr-firewall
+    # => May show error, just ignore it since ot-br-posix does not provide otbr-firewall.service file
+    systemctl start otbr-firewall
+    systemctl status otbr-firewall
diff --git a/src/agent/otbr-agent.default.in b/src/agent/otbr-agent.default.in
index 049686f150..a21d297477 100644
--- a/src/agent/otbr-agent.default.in
+++ b/src/agent/otbr-agent.default.in
@@ -1,5 +1,5 @@
 # Default settings for otbr-agent. This file is sourced by systemd
 
 # Options to pass to otbr-agent
-OTBR_AGENT_OPTS="-I wpan0 -B @OTBR_INFRA_IF_NAME@ spinel+hdlc+uart:///dev/ttyACM0 trel://@OTBR_INFRA_IF_NAME@"
+OTBR_AGENT_OPTS="-d 6 -I wpan0 -B @OTBR_INFRA_IF_NAME@ 'spinel+spi:///dev/spidev1.0?gpio-reset-device=/dev/gpiochip5&gpio-int-device=/dev/gpiochip5&gpio-int-line=12&gpio-reset-line=13&spi-mode=0&spi-speed=2000000&spi-reset-delay=0' trel://@OTBR_INFRA_IF_NAME@"
 OTBR_NO_AUTO_ATTACH=@OTBR_NO_AUTO_ATTACH@
